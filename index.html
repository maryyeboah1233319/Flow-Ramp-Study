<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flow Ramp Study</title>
  <meta name="description" content="Flow Ramp + Study Session Builder (condition-aware) — MVP." />
  <style>
    :root{
      --bg: #0b0f14;
      --panel: #0f1621;
      --panel2:#0e141d;
      --text:#e9eef6;
      --muted:#a7b3c6;
      --soft:#7f8aa1;
      --accent:#78c6b0; /* sage-ish */
      --accent2:#78a6ff; /* muted blue */
      --border: rgba(255,255,255,.08);
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius: 16px;
      --radius2: 12px;
      --focus: 0 0 0 3px rgba(120,198,176,.25);
      --danger:#ff6b6b;
      --ok:#78c6b0;
      --warn:#ffd166;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 600px at 20% 0%, rgba(120,166,255,.10), transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, rgba(120,198,176,.12), transparent 55%),
                  var(--bg);
      color: var(--text);
      line-height:1.35;
    }
    a{color:inherit}
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 28px 18px 56px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, rgba(120,198,176,.95), rgba(120,166,255,.85));
      box-shadow: var(--shadow);
    }
    h1{
      font-size:18px; margin:0;
      letter-spacing:.2px;
    }
    .tag{
      font-size:12px;
      color: var(--muted);
      margin-top:2px;
    }
    .pillbar{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    }
    .pill{
      font-size:12px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      color: var(--muted);
      background: rgba(255,255,255,.02);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns: 1fr;}
      .pillbar{justify-content:flex-start}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .head{
      padding: 16px 16px 10px;
      border-bottom: 1px solid var(--border);
      background: rgba(0,0,0,.12);
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
    }
    .card .head h2{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
    }
    .card .head .sub{
      margin-top:4px;
      font-size:12px; color: var(--muted);
    }
    .card .body{
      padding: 16px;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 520px){
      .row{grid-template-columns:1fr}
    }
    label{
      font-size:12px;
      color: var(--muted);
      display:block;
      margin-bottom:6px;
    }
    select, textarea, input[type="text"]{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(10,14,20,.65);
      color: var(--text);
      outline:none;
    }
    select:focus, textarea:focus, input[type="text"]:focus{ box-shadow: var(--focus); border-color: rgba(120,198,176,.35); }
    textarea{ min-height: 120px; resize: vertical; }
    .toggles{
      display:flex; flex-wrap:wrap; gap:10px;
      margin-top: 8px;
    }
    .toggle{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      padding: 10px 10px;
      border-radius: 12px;
      color: var(--muted);
      font-size: 12px;
      user-select:none;
    }
    .toggle input{ accent-color: var(--accent); }

    .btnbar{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 12px;
    }
    button{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 11px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 600;
      font-size: 13px;
      letter-spacing:.15px;
    }
    button:hover{ border-color: rgba(255,255,255,.18); }
    button:focus{ outline:none; box-shadow: var(--focus); }
    .primary{
      background: linear-gradient(135deg, rgba(120,198,176,.92), rgba(120,166,255,.72));
      border-color: rgba(120,198,176,.35);
      color: #071017;
    }
    .ghost{
      background: transparent;
    }
    .danger{
      border-color: rgba(255,107,107,.35);
      background: rgba(255,107,107,.08);
    }

    .progress{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      overflow:hidden;
      border: 1px solid var(--border);
    }
    .progress > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(120,198,176,.95), rgba(120,166,255,.80));
    }

    .phase{
      padding: 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.18);
      margin-bottom: 12px;
    }
    .phase h3{
      margin:0 0 6px 0;
      font-size: 13px;
      letter-spacing:.2px;
    }
    .phase .meta{
      font-size:12px; color: var(--muted);
      margin-bottom: 10px;
    }
    .phase ul{ margin: 0; padding-left: 18px; color: var(--text); }
    .phase li{ margin: 6px 0; color: rgba(233,238,246,.95); }

    .kbd{
      font-family: var(--mono);
      font-size: 12px;
      border:1px solid var(--border);
      padding: 2px 6px;
      border-radius: 8px;
      color: var(--muted);
      background: rgba(255,255,255,.03);
    }

    .small{
      font-size: 12px;
      color: var(--muted);
    }
    .hint{
      font-size: 12px;
      color: var(--soft);
      margin-top:8px;
    }

    .divider{ height:1px; background: var(--border); margin: 14px 0; }

    .qcard{
      border:1px solid var(--border);
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      padding: 14px;
      margin-bottom: 12px;
    }
    .qtop{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .qtitle{ font-weight:700; font-size: 13px; margin:0; }
    .badge{
      font-size: 11px;
      color: #071017;
      background: linear-gradient(135deg, rgba(120,198,176,.95), rgba(120,166,255,.75));
      padding: 5px 9px;
      border-radius: 999px;
      font-weight: 800;
      letter-spacing:.15px;
    }
    .answerbox{ margin-top:10px; }
    .answerbox textarea{ min-height: 90px; }
    .feedback{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.02);
      color: rgba(233,238,246,.92);
      font-size: 12.5px;
      white-space: pre-wrap;
    }

    .footer{
      margin-top: 14px;
      color: var(--muted);
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Flow Ramp Study</h1>
          <div class="tag">Condition-aware study sessions • Flow Ramp → Active practice → Check → Wrap</div>
        </div>
      </div>
      <div class="pillbar">
        <div class="pill">No login</div>
        <div class="pill">Mobile-first</div>
        <div class="pill">Neutral tone</div>
        <div class="pill">Adjust Load</div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Builder -->
      <div class="card" id="cardBuilder">
        <div class="head">
          <div>
            <h2>Session Builder</h2>
            <div class="sub">Build a study session that matches capacity and your exam methods.</div>
          </div>
          <div class="small"><span class="kbd">MVP</span></div>
        </div>
        <div class="body">
          <div class="row">
            <div>
              <label for="energy">Energy</label>
              <select id="energy">
                <option>Low</option>
                <option selected>Medium</option>
                <option>High</option>
              </select>
            </div>
            <div>
              <label for="focus">Focus</label>
              <select id="focus">
                <option selected>Foggy</option>
                <option>Okay</option>
                <option>Alert</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div>
              <label for="subjectType">Subject type</label>
              <select id="subjectType">
                <option selected>Reading / Memorization</option>
                <option>STEM / Problem-Solving</option>
                <option>Writing / Humanities</option>
              </select>
            </div>
            <div>
              <label for="time">Time available</label>
              <select id="time">
                <option>20</option>
                <option selected>35</option>
                <option>50</option>
                <option>75</option>
                <option>120</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div>
              <label for="mode">Mode</label>
              <select id="mode">
                <option selected>Midterm Review</option>
                <option>Finals Crunch</option>
                <option>Homework </option>
              </select>
            </div>
            <div>
              <label for="preset">Your method preset</label>
              <select id="preset">
                <option selected>One-by-One Q&A</option>
                <option>Formula Recognition</option>
                <option>Fill-in-the-Blank Drill</option>
                <option>Reverse-Order Teaching</option>
                <option>Full-Length Practice Exam</option>
                <option>Mixed Review (Finals)</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div>
              <label for="course">Course / topic label (optional)</label>
              <input id="course" type="text" placeholder="e.g., QTM 100 — Inference & Regression" />
            </div>
            <div>
              <label>Condition toggles (optional)</label>
              <div class="toggles">
                <label class="toggle"><input type="checkbox" id="tBrainfog"> Brain fog</label>
              </div>
            </div>
          </div>

          <div style="margin-top:12px;">
            <label for="topics">Topics (paste bullets / headings / messy notes)</label>
            <textarea id="topics" placeholder="Example:
- z test vs t test
- chi-square test of association
- ANOVA + post hoc
- regression slope/intercept interpretation
- assumptions + residual plots"></textarea>
            <div class="hint">Tip: you can paste exam review topics. The app will generate warm-up + practice items from them.</div>
          </div>

          <div class="btnbar">
            <button class="primary" id="btnGenerate">Generate Session</button>
            <button class="ghost" id="btnReset">Reset</button>
          </div>

          <div class="footer">
            This MVP is an academic support tool.
          </div>
        </div>
      </div>

      <!-- RIGHT: Output / Flow Ramp / Study -->
      <div class="card" id="cardOutput">
        <div class="head">
          <div>
            <h2 id="outTitle">Output</h2>
            <div class="sub" id="outSub">Generate a session to begin.</div>
          </div>
          <div class="small"><span class="kbd" id="stagePill">Idle</span></div>
        </div>
        <div class="body" id="outBody">
          <div class="small">You’ll see:</div>
          <ul class="small">
            <li><b>Flow Ramp</b> (Phase 1 → 2 → Flow Entry)</li>
            <li><b>Study Session</b> (Plan → Active Practice → Check → Wrap)</li>
            <li><b>One-by-One Q&A</b> mode for sequential practice (if selected)</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

<script>
/** =========================
 *  UTILITIES
 *  ========================= */
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

function parseTopics(raw){
  const lines = raw.split(/\n+/).map(s=>s.trim()).filter(Boolean);
  const cleaned = [];
  for(const l of lines){
    const x = l.replace(/^[-•*]\s*/,'').trim();
    if(!x) continue;
    // split on semicolons / commas if user pasted a run-on
    const parts = x.split(/;|\s+\|\s+|•/).map(p=>p.trim()).filter(Boolean);
    for(const p of parts){
      if(p.length >= 2) cleaned.push(p);
    }
  }
  // de-dupe
  return [...new Set(cleaned)];
}

function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function timePlan(total){
  // returns typical allocation for Plan / Active / Check / Wrap
  // bias toward active practice
  const plan = clamp(Math.round(total*0.12), 3, 12);
  const wrap = clamp(Math.round(total*0.10), 3, 12);
  const check = clamp(Math.round(total*0.20), 5, 25);
  const active = total - plan - check - wrap;
  return {plan, active, check, wrap};
}

function loadFactor(energy, focus, toggles){
  // lower = lighter load
  let f = 1.0;
  if(energy === "Low") f -= 0.22;
  if(energy === "High") f += 0.10;
  if(focus === "Foggy") f -= 0.20;
  if(focus === "Alert") f += 0.08;
  if(toggles.brainfog) f -= 0.10;
  if(toggles.pain) f -= 0.08;
  if(toggles.nausea) f -= 0.06;
  return clamp(f, 0.55, 1.15);
}

function estRampMinutes(energy, focus, lf){
  // adaptive ramp length
  let base = 10;
  if(energy === "Low" || focus === "Foggy") base = 12;
  if(energy === "High" && focus === "Alert") base = 7;
  // load factor: lower -> slightly longer ramp, but not huge
  const adj = lf < 0.75 ? 2 : (lf > 1.05 ? -1 : 0);
  return clamp(base + adj, 5, 15);
}

function safeCourseLabel(course){
  const c = (course||"").trim();
  return c ? c : "Your session";
}

/** =========================
 *  FLOW RAMP GENERATION
 *  ========================= */
function buildFlowRamp({energy, focus, subjectType, lf}){
  const rampMin = estRampMinutes(energy, focus, lf);

  const ignition = {
    title: "Phase 1 — Cognitive Ignition",
    minutes: clamp(Math.round(rampMin*0.30), 2, 5),
    bullets: []
  };
  const bridge = {
    title: "Phase 2 — Engagement Bridge",
    minutes: clamp(Math.round(rampMin*0.55), 4, 10),
    bullets: []
  };
  const entry = {
    title: "Flow Entry",
    minutes: clamp(rampMin - ignition.minutes - bridge.minutes, 0, 4),
    bullets: []
  };

  if(subjectType.startsWith("Reading")){
    ignition.bullets = [
      "Skim headings and bold terms. Don’t memorize—just orient.",
      "Mark 3 concepts that feel central (no deep notes yet)."
    ];
    bridge.bullets = [
      "Write a 2–3 sentence summary of one key concept in your own words.",
      "Answer 1 easy question: “What is this concept trying to explain?”"
    ];
    entry.bullets = [
      "Choose one main topic. Begin active recall or practice questions."
    ];
  } else if(subjectType.startsWith("STEM")){
    ignition.bullets = [
      "Scan formulas/steps for today’s topic. Identify the ‘type’ of problem.",
      "Re-read one worked example quickly (no solving yet)."
    ];
    bridge.bullets = [
      "Do 1 medium problem slowly, labeling each step and why it’s used.",
      "Then do 1 shorter problem with fewer notes."
    ];
    entry.bullets = [
      "Start your main practice set. Aim for steady, not rushed."
    ];
  } else { // Writing
    ignition.bullets = [
      "Re-read your last paragraph or outline. Highlight the main claim.",
      "List 3 points you want to argue/explain (no full sentences yet)."
    ];
    bridge.bullets = [
      "Draft 6–8 bullet lines for one paragraph (claim → evidence → link).",
      "Rewrite one sentence for clarity (short + direct)."
    ];
    entry.bullets = [
      "Begin drafting your main section. Keep momentum."
    ];
  }

  // Adjust load: if low factor, remove one bullet from each phase
  if(lf < 0.75){
    ignition.bullets = ignition.bullets.slice(0,1);
    bridge.bullets = bridge.bullets.slice(0,1);
  }
  if(lf > 1.05){
    // add one optional bullet
    bridge.bullets.push("Optional: teach the concept out loud in 30–60 seconds.");
  }

  return {rampMin, phases:[ignition, bridge, entry]};
}

/** =========================
 *  STUDY SESSION GENERATION
 *  ========================= */
function generateSession({energy, focus, time, subjectType, mode, preset, topics, toggles, course}){
  const lf = loadFactor(energy, focus, toggles);
  const total = Number(time);

  const ramp = buildFlowRamp({energy, focus, subjectType, lf});

  // Reserve ramp time from total. Ensure at least 12 min remaining for actual study.
  const remaining = clamp(total - ramp.rampMin, 12, total);
  const blocks = timePlan(remaining);

  const session = {
    meta: { energy, focus, subjectType, mode, preset, total, remaining, course: safeCourseLabel(course), lf },
    ramp,
    blocks,
    plan: [],
    active: [],
    check: [],
    wrap: [],
    oneByOne: null
  };

  // helper: choose 3-6 topics depending on time/load
  const maxTopics = clamp(Math.round((remaining/20) * (lf < 0.8 ? 2.5 : 3.5)), 2, 7);
  const chosen = topics.length ? topics.slice(0, maxTopics) : ["Core concepts", "Practice problems", "Common traps"];

  // PLAN block (neutral, structured)
  session.plan.push(`Pick your target topics (${Math.min(chosen.length, 4)}): ${chosen.slice(0,4).join(", ")}.`);
  session.plan.push(`Define success for this session: “I can answer questions without notes on 2–3 topics.”`);
  if(mode === "Finals Crunch"){
    session.plan.push(`Use rotation: topic → 2 questions → quick teach-back line, then switch.`);
  } else {
    session.plan.push(`Start with accuracy, then build speed if capacity allows.`);
  }

  // Build depending on preset
  if(preset === "One-by-One Q&A"){
    const qCount = clamp(Math.round((blocks.active + blocks.check) * (lf < 0.8 ? 0.35 : 0.5)), 8, 22);
    const qs = buildOneByOneQuestions(chosen, subjectType, qCount, mode);
    session.active.push(`Work through questions sequentially. Do not skip ahead; keep the loop: answer → check → adjust.`);
    session.active.push(`Target pace: ${Math.max(1, Math.round((blocks.active+blocks.check)/Math.max(1,qCount)))} min/question.`);
    session.check.push(`After every 4 questions: summarize the rule in 1 sentence (no fluff).`);
    session.check.push(`Log 2 “tempting wrong answers” you chose and why they were tempting.`);
    session.wrap.push(`Pick 2 missed concepts. Write: “If I see ___, I should use ___ because ___.”`);
    session.wrap.push(`Next session: redo the 3 hardest questions without looking at explanations.`);
    session.oneByOne = {questions: qs, index: 0, answers: Array(qs.length).fill(""), showHint: false};
  }
  else if(preset === "Formula Recognition"){
    const n = clamp(Math.round((blocks.active + blocks.check) * (lf < 0.8 ? 0.30 : 0.45)), 10, 26);
    const cards = buildFormulaRecognition(chosen, n, mode);
    session.active.push(`Do recognition first: scenario → correct test/formula → assumption check.`);
    session.active.push(`Then do 1–2 mini-calcs only if you have capacity.`);
    session.check.push(`For each wrong card, write the distinguishing cue (e.g., “paired vs independent”).`);
    session.wrap.push(`Make a 5-line “decision tree” for the most confusing set (e.g., z vs t vs chi-square).`);
    session.wrap.push(`Next session: redo the wrong cards first, then add 5 new ones.`);
    session.oneByOne = {questions: cards, index: 0, answers: Array(cards.length).fill(""), showHint: false, mode: "formula"};
  }
  else if(preset === "Fill-in-the-Blank Drill"){
    const n = clamp(Math.round((blocks.active + blocks.check) * (lf < 0.8 ? 0.40 : 0.60)), 12, 30);
    const blanks = buildFillBlanks(chosen, n, lf);
    session.active.push(`Complete blanks in short bursts. Aim for accuracy before speed.`);
    session.check.push(`Circle the blanks you missed twice. Those become your mini-review list.`);
    session.wrap.push(`Write 3 corrected statements using the missing words (full sentence).`);
    session.oneByOne = {questions: blanks, index: 0, answers: Array(blanks.length).fill(""), showHint: lf < 0.8};
  }
  else if(preset === "Reverse-Order Teaching"){
    session.active.push(`Start from “exam output”: write what the professor would ask about ${chosen[0]}.`);
    session.active.push(`Teach-back scaffold: Definition → Example → Common trap → How to spot it on an exam.`);
    session.check.push(`Backfill: list the exact steps/assumptions you keep forgetting.`);
    session.wrap.push(`Close with rapid retrieval: answer 6 quick questions from today’s topics.`);
  }
  else if(preset === "Full-Length Practice Exam"){
    session.active.push(`Mini-diagnostic (5 min): list your weakest 3 areas without looking at notes.`);
    session.active.push(`Timed block: answer a short set of exam-style questions.`);
    session.check.push(`Error log: What I chose → Why → Correct rule → New example.`);
    session.wrap.push(`Redo the hardest 3 questions immediately. That’s the retention step.`);
  }
  else if(preset === "Mixed Review (Finals)"){
    session.active.push(`3-topic rotation: 3-min recap → 2 questions → 1 teach-back line → switch.`);
    session.check.push(`After rotation, do a “weakest link” pass: the 1 topic you avoided.`);
    session.wrap.push(`Make tomorrow’s starting list: 3 items only (high yield).`);
  }

  // Load adjustments
  if(lf < 0.75){
    session.plan.push(`Load adjustment: keep tasks small, prioritize completion over volume.`);
    session.wrap.unshift(`Capacity note: stop while you’re still stable; leave a clear restart cue for later.`);
  } else if(lf > 1.05){
    session.check.push(`If you’re alert: add a 5-minute speed round at the end (no notes).`);
  }

  return session;
}

/** =========================
 *  QUESTION GENERATORS
 *  ========================= */
function buildOneByOneQuestions(topics, subjectType, count, mode){
  const questions = [];
  const stemsReading = [
    "Define {t} in one sentence. Then give a quick example.",
    "What’s the main purpose of {t}? (Answer like a test key.)",
    "What’s a common trap or misconception about {t}?",
    "Explain {t} as if tutoring a friend in 45 seconds.",
    "How would you recognize {t} in a multiple-choice question?"
  ];
  const stemsSTEM = [
    "Given a scenario, when would you use {t}? List the cue.",
    "For {t}, name 2 assumptions you should check.",
    "Set up (don’t fully solve) a problem where {t} is required.",
    "Interpret the key parameter/result for {t} in context.",
    "What would a residual/diagnostic issue look like for {t}?"
  ];
  const stemsWriting = [
    "What claim would you make about {t}? Provide one supporting point.",
    "Rewrite this idea about {t} more clearly (short + direct).",
    "Give a counterargument for {t}, then respond to it.",
    "Turn {t} into a 3-bullet mini-outline.",
    "What evidence would strengthen a paragraph about {t}?"
  ];

  const stems = subjectType.startsWith("Reading") ? stemsReading
                : subjectType.startsWith("STEM") ? stemsSTEM
                : stemsWriting;

  for(let i=0;i<count;i++){
    const t = topics[i % topics.length] || "the topic";
    const template = stems[i % stems.length];
    const prompt = template.replace("{t}", t);
    const hint = buildHintFor(prompt, t, mode, subjectType);
    const check = buildCheckFor(prompt, t, mode, subjectType);
    questions.push({type:"qa", topic:t, prompt, hint, check});
  }
  return questions;
}

function buildFormulaRecognition(topics, count, mode){
  // This is generic recognition cards; user can make them subject-specific with topics.
  const cardTypes = [
    (t)=>`Scenario recognition: You need to analyze "${t}". What test/formula would you use, and why?`,
    (t)=>`Assumption check: For "${t}", list the key assumptions you must verify.`,
    (t)=>`Interpretation: For "${t}", how would you interpret the main statistic/parameter in context?`,
    (t)=>`Distinguish: How is "${t}" different from a closely related method? Give one cue.`,
    (t)=>`Common trap: What makes people choose the wrong method for "${t}"?`
  ];
  const questions = [];
  for(let i=0;i<count;i++){
    const t = topics[i % topics.length] || "the topic";
    const make = cardTypes[i % cardTypes.length];
    const prompt = make(t);
    const hint = `Look for the cue: variable types (quant/qual), groups (1 vs 2+), independent vs paired, and the question (estimate vs test vs association).`;
    const check = `Good answer includes: (1) method/test name, (2) 1–2 cues that justify it, (3) at least one assumption or condition check.`;
    questions.push({type:"formula", topic:t, prompt, hint, check});
  }
  return questions;
}

function buildFillBlanks(topics, count, lf){
  const starters = [
    (t)=>`{t}: The key idea is __________, which means __________.`,
    (t)=>`{t}: A common condition/assumption is __________.`,
    (t)=>`{t}: If you see __________ in a question, you should consider __________.`,
    (t)=>`{t}: The interpretation of the main result is __________.`,
    (t)=>`{t}: A typical mistake is __________; correct approach: __________.`
  ];
  const questions = [];
  for(let i=0;i<count;i++){
    const t = topics[i % topics.length] || "the topic";
    const prompt = starters[i % starters.length](t).replaceAll("{t}", t);
    const hint = lf < 0.8 ? `Use short phrases. You’re aiming for recognition + recall, not perfect prose.` : `Aim for exam-ready phrasing.`;
    const check = `Check: Did you include the missing key term(s) and a correct meaning? If not, rewrite it once.`;
    questions.push({type:"blank", topic:t, prompt, hint, check});
  }
  return questions;
}

function buildHintFor(prompt, topic, mode, subjectType){
  // concise, non-infantilizing hint
  if(subjectType.startsWith("STEM")){
    return `Anchor on: what variables you have, how many groups, and whether the goal is estimate, compare, or test association.`;
  }
  if(subjectType.startsWith("Writing")){
    return `Use a tight structure: claim → evidence/example → link back to the question.`;
  }
  return `Answer like a key: definition + one example + one cue for recognizing it on exams.`;
}

function buildCheckFor(prompt, topic, mode, subjectType){
  return `Check: Is your answer specific, correct, and test-ready? Include one cue that helps you choose/recognize it under exam pressure.`;
}

/** =========================
 *  RENDERING / STATE
 *  ========================= */
let STATE = { session: null, stage: "idle" };

const el = (id)=>document.getElementById(id);

function setStage(stage){
  STATE.stage = stage;
  el("stagePill").textContent = stage.toUpperCase();
}

function renderSession(session){
  STATE.session = session;
  setStage("flow-ramp");
  el("outTitle").textContent = session.meta.course;
  el("outSub").textContent = `Flow Ramp (${session.ramp.rampMin} min) → Study (${session.meta.remaining} min) • Preset: ${session.meta.preset}`;

  renderFlowRamp(session);
}

function renderFlowRamp(session){
  const {phases, rampMin} = session.ramp;
  const lf = session.meta.lf;

  let html = `
    <div class="progress" aria-label="progress"><div id="progFill"></div></div>
    <div class="hint" style="margin-top:10px;">
      Flow Ramp is part of studying: it reduces task-switch cost and gets your brain online.
    </div>
    <div class="divider"></div>
  `;

  phases.forEach((p, idx)=>{
    html += `
      <div class="phase" id="phase_${idx}">
        <h3>${p.title}</h3>
        <div class="meta">Estimated time: ${p.minutes} min</div>
        <ul>
          ${p.bullets.map(b=>`<li>${b}</li>`).join("")}
        </ul>
      </div>
    `;
  });

  html += `
    <div class="btnbar">
      <button class="primary" id="btnStartStudy">Start Study Session</button>
      <button id="btnAdjustLoad">Adjust Load</button>
      <button id="btnShorten">Shorten Ramp</button>
    </div>
    <div class="small" style="margin-top:10px;">
      Load factor: <span class="kbd">${lf.toFixed(2)}</span> (lower = lighter pacing)
    </div>
  `;

  el("outBody").innerHTML = html;

  // progress fill: 35% at ramp stage
  el("progFill").style.width = "35%";

  el("btnStartStudy").onclick = ()=>renderStudyPlan(session);
  el("btnAdjustLoad").onclick = ()=>{
    // reduce load by simulating lower factor impact
    session.meta.lf = clamp(session.meta.lf - 0.12, 0.55, 1.15);
    session.ramp = buildFlowRamp({
      energy: session.meta.energy,
      focus: session.meta.focus,
      subjectType: session.meta.subjectType,
      lf: session.meta.lf
    });
    renderFlowRamp(session);
  };
  el("btnShorten").onclick = ()=>{
    // shorten ramp by nudging to "alert/high" behavior for minutes only
    // (without changing labels)
    const rampMin = clamp(session.ramp.rampMin - 3, 5, 15);
    // scale phase times proportionally
    const phases = session.ramp.phases.map(p=>({...p}));
    const totalOld = phases.reduce((a,p)=>a+p.minutes,0);
    phases.forEach(p=>{
      p.minutes = clamp(Math.round(p.minutes * (rampMin/totalOld)), p.title.includes("Ignition")?2:0, 10);
    });
    // fix rounding mismatch
    let sum = phases.reduce((a,p)=>a+p.minutes,0);
    while(sum > rampMin){ phases[1].minutes = Math.max(3, phases[1].minutes-1); sum--; }
    while(sum < rampMin){ phases[1].minutes = Math.min(10, phases[1].minutes+1); sum++; }

    session.ramp.rampMin = rampMin;
    session.ramp.phases = phases;
    renderFlowRamp(session);
  };
}

function renderStudyPlan(session){
  setStage("study-plan");
  const {plan, active, check, wrap, blocks} = session;
  el("outSub").textContent = `Study Plan (${session.meta.remaining} min): Plan ${blocks.plan} • Active ${blocks.active} • Check ${blocks.check} • Wrap ${blocks.wrap}`;

  const chosenToggles = [];
  if(document.getElementById("tBrainfog").checked) chosenToggles.push("Brain fog");
  if(document.getElementById("tPain").checked) chosenToggles.push("Pain day");
  if(document.getElementById("tNausea").checked) chosenToggles.push("Nausea day");

  const toggleLine = chosenToggles.length ? `• Toggles: ${chosenToggles.join(", ")}` : "";

  let html = `
    <div class="progress"><div id="progFill"></div></div>
    <div class="hint" style="margin-top:10px;">
      Capacity-aware session: ${session.meta.energy} energy, ${session.meta.focus} focus ${toggleLine}
    </div>
    <div class="divider"></div>

    <div class="phase">
      <h3>Plan (${blocks.plan} min)</h3>
      <ul>${plan.map(x=>`<li>${x}</li>`).join("")}</ul>
    </div>

    <div class="phase">
      <h3>Active Practice (${blocks.active} min)</h3>
      <ul>${active.map(x=>`<li>${x}</li>`).join("")}</ul>
    </div>

    <div class="phase">
      <h3>Check Understanding (${blocks.check} min)</h3>
      <ul>${check.map(x=>`<li>${x}</li>`).join("")}</ul>
    </div>

    <div class="phase">
      <h3>Wrap + Next Step (${blocks.wrap} min)</h3>
      <ul>${wrap.map(x=>`<li>${x}</li>`).join("")}</ul>
    </div>

    <div class="btnbar">
      ${session.oneByOne ? `<button class="primary" id="btnOneByOne">Open One-by-One Practice</button>` : ""}
      <button id="btnBackToRamp">Back to Flow Ramp</button>
      <button class="danger" id="btnNew">New Session</button>
    </div>
  `;

  el("outBody").innerHTML = html;
  el("progFill").style.width = "70%";

  if(session.oneByOne){
    el("btnOneByOne").onclick = ()=>renderOneByOne(session);
  }
  el("btnBackToRamp").onclick = ()=>renderFlowRamp(session);
  el("btnNew").onclick = ()=>{
    STATE.session = null;
    setStage("idle");
    el("outTitle").textContent = "Output";
    el("outSub").textContent = "Generate a session to begin.";
    el("outBody").innerHTML = `
      <div class="small">You’ll see:</div>
      <ul class="small">
        <li><b>Flow Ramp</b> (Phase 1 → 2 → Flow Entry)</li>
        <li><b>Study Session</b> (Plan → Active Practice → Check → Wrap)</li>
        <li><b>One-by-One Q&A</b> mode for sequential practice (if selected)</li>
      </ul>
    `;
  };
}

function renderOneByOne(session){
  setStage("one-by-one");
  const obo = session.oneByOne;
  const q = obo.questions[obo.index];
  const total = obo.questions.length;

  el("outSub").textContent = `One-by-One Practice • ${obo.index+1} / ${total}`;

  const typeLabel = q.type === "formula" ? "Formula / Method" : q.type === "blank" ? "Fill-in" : "Q&A";
  const hintVisible = obo.showHint ? "" : "style='display:none'";

  let html = `
    <div class="progress"><div id="progFill"></div></div>
    <div class="divider"></div>

    <div class="qcard">
      <div class="qtop">
        <div>
          <div class="qtitle">${typeLabel}</div>
          <div class="small" style="margin-top:4px;">Topic: <span class="kbd">${q.topic}</span></div>
        </div>
        <div class="badge">${session.meta.preset}</div>
      </div>

      <div class="divider"></div>
      <div style="font-size:13px; font-weight:650; letter-spacing:.15px;">Prompt</div>
      <div class="small" style="margin-top:8px; white-space:pre-wrap;">${q.prompt}</div>

      <div class="answerbox">
        <label for="ans">Your answer</label>
        <textarea id="ans" placeholder="Write your answer here...">${obo.answers[obo.index] || ""}</textarea>
      </div>

      <div class="btnbar">
        <button class="primary" id="btnCheck">Check</button>
        <button id="btnToggleHint">${obo.showHint ? "Hide hint" : "Show hint"}</button>
        <button id="btnAdjustLoad2">Adjust Load</button>
      </div>

      <div class="feedback" id="hintBox" ${hintVisible}><b>Hint:</b> ${q.hint}</div>
      <div class="feedback" id="checkBox" style="display:none;"></div>

      <div class="btnbar" style="margin-top:12px;">
        <button id="btnPrev">Prev</button>
        <button id="btnNext">Next</button>
        <button id="btnExit">Exit to Plan</button>
      </div>
    </div>

    <div class="small">Tip: use the same loop you used for midterms/finals: answer → check → write the rule → do one more example.</div>
  `;

  el("outBody").innerHTML = html;

  // progress fill: 70-100%
  const pct = 70 + Math.round((obo.index/(Math.max(1,total-1))) * 30);
  el("progFill").style.width = pct + "%";

  const saveAnswer = ()=>{
    obo.answers[obo.index] = el("ans").value;
  };

  el("btnCheck").onclick = ()=>{
    saveAnswer();
    const box = el("checkBox");
    box.style.display = "block";
    box.textContent = q.check + "\n\nSelf-check prompt: What cue would help you choose/recall this faster under exam pressure?";
  };

  el("btnToggleHint").onclick = ()=>{
    obo.showHint = !obo.showHint;
    renderOneByOne(session);
  };

  el("btnAdjustLoad2").onclick = ()=>{
    // Adjust load here means: enable hints + reduce next prompts burden by showing shorter checks
    obo.showHint = true;
    // soften check text (professional) by compressing
    obo.questions = obo.questions.map(item=>({
      ...item,
      check: "Check: state the rule/cue in 1–2 lines. If incorrect, rewrite once using the cue that distinguishes it."
    }));
    renderOneByOne(session);
  };

  el("btnPrev").onclick = ()=>{
    saveAnswer();
    obo.index = Math.max(0, obo.index-1);
    renderOneByOne(session);
  };

  el("btnNext").onclick = ()=>{
    saveAnswer();
    obo.index = Math.min(total-1, obo.index+1);
    renderOneByOne(session);
  };

  el("btnExit").onclick = ()=>{
    saveAnswer();
    renderStudyPlan(session);
  };
}

/** =========================
 *  WIRE UP CONTROLS
 *  ========================= */
el("btnGenerate").onclick = ()=>{
  const energy = el("energy").value;
  const focus = el("focus").value;
  const subjectType = el("subjectType").value;
  const time = el("time").value;
  const mode = el("mode").value;
  const preset = el("preset").value;
  const course = el("course").value;

  const toggles = {
    brainfog: el("tBrainfog").checked,
    pain: el("tPain").checked,
    nausea: el("tNausea").checked
  };

  const topics = parseTopics(el("topics").value);
  const session = generateSession({energy, focus, time, subjectType, mode, preset, topics, toggles, course});
  renderSession(session);
};

el("btnReset").onclick = ()=>{
  el("topics").value = "";
  el("course").value = "";
  el("energy").value = "Medium";
  el("focus").value = "Foggy";
  el("subjectType").value = "Reading / Memorization";
  el("time").value = "35";
  el("mode").value = "Midterm Review";
  el("preset").value = "One-by-One Q&A";
  el("tBrainfog").checked = false;
  el("tPain").checked = false;
  el("tNausea").checked = false;
};
</script>
</body>
</html>
